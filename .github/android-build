name: Android CI - Build & Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  GRADLE_BUILD_TYPE: Release

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: r0adkll/setup-android@v2
        with:
          api-level: 34
          build-tools: 34.0.0
          target: android-34
          ndk: none

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-cache-${{ runner.os }}-

      - name: Run Gradle assemble
        run: ./gradlew clean assemble${{ env.GRADLE_BUILD_TYPE }} -Pci=true
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.path }}

      - name: Collect APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-artifacts
          path: app/build/outputs/apk/**/**/*.apk

  sign_and_release:
    name: Sign & Release (optional)
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: apk-artifacts
          path: ./artifacts

      - name: Install jarsigner tools
        run: sudo apt-get update && sudo apt-get install -y zipalign apksigner

      - name: Decrypt signing key
        env:
          SIGNING_KEY_ENC: ${{ secrets.SIGNING_KEY_ENC }}
          SIGNING_KEY_PASS: ${{ secrets.SIGNING_KEY_PASS }}
        run: |
          if [ -n "$SIGNING_KEY_ENC" ]; then
            echo "$SIGNING_KEY_ENC" | base64 --decode > signing.keystore.enc
            openssl enc -aes-256-cbc -d -pbkdf2 -iter 100000 -in signing.keystore.enc -out signing.keystore -pass pass:"$SIGNING_KEY_PASS"
          fi

      - name: Find apk and sign (release)
        run: |
          APK=$(ls artifacts/**/*.apk | head -n1)
          echo "Signing $APK"
          # adjust key alias and passwords using secrets
          jarsigner -keystore signing.keystore -storepass "${{ secrets.KEYSTORE_PASS }}" -keypass "${{ secrets.KEY_PASS }}" "$APK" "${{ secrets.KEY_ALIAS }}"
          # zipalign (optional)
          zipalign -v -p 4 "$APK" aligned.apk
          mv aligned.apk release-signed.apk

      - name: Create GitHub Release (optional)
        uses: softprops/action-gh-release@v1
        with:
          files: release-signed.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
